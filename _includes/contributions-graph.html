{% comment %}
  Contributions Graph Component
  Displays commit activity over the past 6 months
  Usage: {% include contributions-graph.html %}
{% endcomment %}

<div class="contributions-graph card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">
        <i class="fa-solid fa-chart-line text-primary me-2"></i>{% t contributions-graph.title %}
      </h5>
      <a href="https://github.com/AntennaPod/AntennaPod/graphs/contributors" target="_blank" rel="noopener" 
         class="btn btn-sm btn-primary">
        <i class="fa-brands fa-github me-1"></i>{% t contributions-graph.join-cta %}
      </a>
    </div>
    <p class="text-body-secondary small mb-3">{% t contributions-graph.description %}</p>
    
    <div id="contributions-graph-container">
      <div class="text-center py-4 text-body-secondary">
        <i class="fa-solid fa-spinner fa-spin me-2"></i>{% t contributions-graph.loading %}
      </div>
    </div>
    
    <div id="contributions-stats" class="d-none mt-3 pt-3 border-top">
      <div class="row text-center g-3">
        <div class="col-4">
          <div class="fs-4 fw-bold text-primary" id="total-commits">-</div>
          <div class="small text-body-secondary">{% t contributions-graph.commits %}</div>
        </div>
        <div class="col-4">
          <div class="fs-4 fw-bold text-primary" id="this-week-commits">-</div>
          <div class="small text-body-secondary">{% t contributions-graph.this-week %}</div>
        </div>
        <div class="col-4">
          <div class="fs-4 fw-bold text-primary" id="contributors-count">-</div>
          <div class="small text-body-secondary">{% t contributors.title %}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.contributions-graph-bars {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  height: 6rem;
  gap: 2px;
  padding: 0.5rem 0;
}

.commit-bar {
  flex: 1;
  min-width: 4px;
  max-width: 12px;
  background: var(--bs-primary);
  border-radius: 2px 2px 0 0;
  transition: opacity 0.2s ease;
  position: relative;
}

.commit-bar:hover {
  opacity: 0.8;
}

.commit-bar[data-bs-toggle="tooltip"] {
  cursor: pointer;
}

.graph-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--bs-secondary-color);
  margin-top: 0.25rem;
}
</style>

<script>
(function() {
  'use strict';
  
  var GITHUB_API = 'https://api.github.com/repos/AntennaPod/AntennaPod/stats/participation';
  
  function fetchContributions() {
    var container = document.getElementById('contributions-graph-container');
    var statsContainer = document.getElementById('contributions-stats');
    if (!container) return;
    
    // Check localStorage cache (1 hour)
    var cacheKey = 'contributions_cache';
    var cacheTimeKey = 'contributions_cache_time';
    var cached = localStorage.getItem(cacheKey);
    var cacheTime = localStorage.getItem(cacheTimeKey);
    var oneHour = 60 * 60 * 1000;
    
    if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < oneHour) {
      renderGraph(JSON.parse(cached), container, statsContainer);
      return;
    }
    
    fetch(GITHUB_API, {
      method: 'GET',
      headers: {
        'Accept': 'application/vnd.github.v3+json'
      }
    })
    .then(function(response) {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(function(data) {
      localStorage.setItem(cacheKey, JSON.stringify(data));
      localStorage.setItem(cacheTimeKey, Date.now().toString());
      renderGraph(data, container, statsContainer);
    })
    .catch(function(error) {
      console.error('Contributions fetch error:', error);
      container.innerHTML = '<div class="text-body-secondary small"><i class="fa-solid fa-exclamation-circle me-2"></i>{% t contributions-graph.error %}</div>';
    });
  }
  
  function renderGraph(data, container, statsContainer) {
    if (!data || !data.all) {
      container.innerHTML = '<div class="text-body-secondary small">No data available.</div>';
      return;
    }
    
    // Get last 26 weeks (6 months)
    var weeks = data.all.slice(-26);
    var maxCommits = Math.max.apply(null, weeks) || 1;
    var totalCommits = weeks.reduce(function(a, b) { return a + b; }, 0);
    var thisWeekCommits = weeks[weeks.length - 1] || 0;
    
    // Calculate date range
    var now = new Date();
    var sixMonthsAgo = new Date(now.getTime() - (26 * 7 * 24 * 60 * 60 * 1000));
    
    var html = '<div class="contributions-graph-bars">';
    weeks.forEach(function(commits, index) {
      var height = Math.max(4, (commits / maxCommits) * 100);
      var weekDate = new Date(sixMonthsAgo.getTime() + (index * 7 * 24 * 60 * 60 * 1000));
      var weekLabel = weekDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      
      html += '<div class="commit-bar" style="height: ' + height + '%;" ';
      html += 'data-bs-toggle="tooltip" data-bs-placement="top" ';
      html += 'title="' + commits + ' commits - Week of ' + weekLabel + '">';
      html += '</div>';
    });
    html += '</div>';
    
    html += '<div class="graph-labels">';
    html += '<span>' + sixMonthsAgo.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) + '</span>';
    html += '<span>' + now.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) + '</span>';
    html += '</div>';
    
    container.innerHTML = html;
    
    // Update stats
    document.getElementById('total-commits').textContent = totalCommits;
    document.getElementById('this-week-commits').textContent = thisWeekCommits;
    statsContainer.classList.remove('d-none');
    
    // Fetch contributor count
    fetchContributorCount();
    
    // Initialize tooltips
    var tooltipElements = container.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipElements.forEach(function(el) {
      new bootstrap.Tooltip(el);
    });
  }
  
  function fetchContributorCount() {
    var countEl = document.getElementById('contributors-count');
    
    fetch('https://api.github.com/repos/AntennaPod/AntennaPod', {
      method: 'GET',
      headers: { 'Accept': 'application/vnd.github.v3+json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      // This gives subscriber count, we need to fetch contributors separately
      fetch('https://api.github.com/repos/AntennaPod/AntennaPod/contributors?per_page=1', {
        method: 'GET',
        headers: { 'Accept': 'application/vnd.github.v3+json' }
      })
      .then(function(response) {
        // Get total from Link header
        var link = response.headers.get('Link');
        if (link) {
          var match = link.match(/page=(\d+)>; rel="last"/);
          if (match) {
            countEl.textContent = match[1];
          }
        }
      });
    })
    .catch(function() {
      countEl.textContent = '100+';
    });
  }
  
  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchContributions);
  } else {
    fetchContributions();
  }
})();
</script>

